<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tha√Ø Garden ‚Äì Suivi de commande</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />

  <!-- Tailwind CDN + couleurs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#704B24',
            accent:  '#ED8B00'
          },
          fontFamily: {
            sans: ['Noto Sans', 'sans-serif'],
            serif: ['Playfair Display', 'serif']
          }
        }
      }
    };
  </script>
  <style>
    body { font-family: 'Noto Sans', sans-serif; }
    h1, h2 { font-family: 'Playfair Display', serif; }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-800">

  <!-- Header minimal -->
  <header class="fixed top-0 w-full bg-white/70 backdrop-blur-sm shadow-md z-50">
    <nav class="max-w-5xl mx-auto flex items-center justify-between py-4 px-6">
      <a href="index.html" class="text-2xl font-bold text-primary">Tha√Ø Garden</a>
      <a href="index.html" class="text-accent font-semibold hover:underline">Retour accueil</a>
    </nav>
  </header>

  <!-- Contenu principal -->
  <main class="flex-1 pt-24 pb-12 max-w-3xl mx-auto px-4 text-center">
    <h1 class="text-4xl font-extrabold text-primary mb-10">Suivi de votre commande</h1>

    <div id="demand-status-message" class="bg-white/70 backdrop-blur-sm p-8 rounded-lg shadow-md space-y-4 mb-8 hidden">
      <p class="text-lg font-semibold" id="demand-message-text"></p>
      <button id="btn-new-demand-from-suivi" class="px-6 py-3 bg-accent text-white font-bold rounded-lg shadow-md hover:shadow-lg transition hidden">Faire une nouvelle demande</button>
    </div>

    <div id="order-details" class="bg-white/70 backdrop-blur-sm p-8 rounded-lg shadow-md space-y-4 hidden">
      <p class="text-lg"><strong>Num√©ro de commande :</strong> <span id="order-id"></span></p>
      <p class="text-lg"><strong>Statut actuel :</strong> <span id="order-status" class="font-semibold"></span></p>
      <p class="text-lg"><strong>Cr√©neau de livraison :</strong> <span id="delivery-slot"></span></p>
      <div id="order-items" class="text-left mt-4">
        <h3 class="font-semibold text-xl mb-2">Articles :</h3>
        <ul id="items-list" class="list-disc list-inside"></ul>
      </div>
      <p class="text-xl font-bold mt-4">Total : <span id="order-total"></span>‚Ç¨</p>
    </div>

    </main>

  <script type="module">
    import { supabase } from './js/supabase-client.js';

    const demandStatusMessageDiv = document.getElementById('demand-status-message');
    const demandMessageText = document.getElementById('demand-message-text');
    const btnNewDemandFromSuivi = document.getElementById('btn-new-demand-from-suivi');
    const orderDetailsDiv = document.getElementById('order-details');

    btnNewDemandFromSuivi.addEventListener('click', () => {
      localStorage.removeItem('currentDemandId');
      window.location.href = 'commande.html';
    });

    let retryCount = 0;
    const MAX_RETRIES = 15;
    const RETRY_DELAY_MS = 250; // 250ms delay

    async function renderStatus() {
      const currentDemandId = localStorage.getItem('currentDemandId');
      console.log('currentDemandId:', currentDemandId);

      if (!currentDemandId) {
        demandStatusMessageDiv.classList.remove('hidden');
        demandMessageText.textContent = 'Aucune commande en cours ou trouv√©e.';
        btnNewDemandFromSuivi.classList.remove('hidden');
        orderDetailsDiv.classList.add('hidden');
        return;
      }

      const { data: order, error } = await supabase.from('orders').select('*').eq('id', currentDemandId).single();

      if (error) {
        console.error('Error fetching order:', error);
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          setTimeout(renderStatus, RETRY_DELAY_MS);
        } else {
          demandStatusMessageDiv.classList.remove('hidden');
          demandMessageText.textContent = 'Erreur lors du chargement de la commande. Veuillez r√©essayer.';
          btnNewDemandFromSuivi.classList.remove('hidden');
          orderDetailsDiv.classList.add('hidden');
        }
        return;
      }

      if (!order) {
        demandStatusMessageDiv.classList.remove('hidden');
        demandMessageText.textContent = 'Commande introuvable.';
        btnNewDemandFromSuivi.classList.remove('hidden');
        orderDetailsDiv.classList.add('hidden');
        return;
      }

      // Reset retry count if order is found
      retryCount = 0;

      if (order.status === 'submitted') {
        demandStatusMessageDiv.classList.remove('hidden');
        demandMessageText.innerHTML = '‚åõ En attente de validation du restaurant.<br><span class="text-sm text-gray-600">Cela ne prendra pas plus de quelques minutes. En cas de probl√®me, contactez le restaurant au <a href="tel:+33987117057" class="text-accent hover:underline">+33 9 87 11 70 57</a>.</span>';
        btnNewDemandFromSuivi.classList.add('hidden');
        orderDetailsDiv.classList.add('hidden');
      } else if (order.status === 'refused') {
        demandStatusMessageDiv.classList.remove('hidden');
        demandMessageText.innerHTML = `Votre demande a √©t√© refus√©e par le restaurant.<br><span class="text-sm text-gray-600">Le restaurant n'est malheureusement pas en mesure de prendre votre commande pour le moment. ${order.refusal_reason ? `<br>Motif: ${order.refusal_reason}` : ''}</span>`;
        btnNewDemandFromSuivi.classList.remove('hidden');
        orderDetailsDiv.classList.add('hidden');
      } else {
        demandStatusMessageDiv.classList.add('hidden');
        orderDetailsDiv.classList.remove('hidden');
        renderOrderDetails(order);
      }
    }

    function renderOrderDetails(order) {
      const statusConfig = {
          submitted: { icon: '‚è≥', color: 'text-yellow-500', text: 'En attente' },
          pending: { icon: '‚è≥', color: 'text-yellow-500', text: 'En attente' },
          accepted: { icon: '‚úÖ', color: 'text-green-500', text: 'Accept√©e' },
          preparing: { icon: '<span class="text-accent">üç≥</span>', color: 'text-yellow-500', text: 'En pr√©paration' },
          ready: { icon: '<span class="text-green-500">‚úÖ</span>', color: 'text-green-500', text: 'Pr√™te' },
          delivered: { icon: '<span class="text-gray-500">üöö</span>', color: 'text-gray-500', text: 'Livr√©e' }
      };

      document.getElementById('order-id').textContent = order.id.slice(0, 8); // Display first 8 chars of ID
      document.getElementById('delivery-slot').textContent = order.delivery_slot ? order.delivery_slot.substring(0, 5) : "En attente de confirmation du cr√©neau.";
      document.getElementById('order-total').textContent = order.total.toFixed(2);

      const config = statusConfig[order.status] || {};
      const statusElement = document.getElementById('order-status');
      statusElement.innerHTML = `${config.icon || ''} ${config.text || order.status}`;
      statusElement.className = 'font-semibold'; // Reset classes
      statusElement.classList.add(config.color || '');

      const itemsList = document.getElementById('items-list');
      itemsList.innerHTML = '';
      if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
          const li = document.createElement('li');
          if (item.isWok && item.details) {
              li.innerHTML = `
                  <strong>${item.name} (${item.quantity})</strong>
                  <ul class="list-disc list-inside pl-4 text-sm">
                      <li><strong>Base:</strong> ${item.details?.base || 'Non sp√©cifi√©e'}</li>
                      <li><strong>Pulpes:</strong> ${(item.details?.pulpes || []).join(', ') || 'Aucune'}</li>
                      <li><strong>Favoris:</strong> ${(item.details?.favoris || []).join(', ') || 'Aucun'}</li>
                      <li><strong>Sauce:</strong> ${item.details?.sauce || 'Non sp√©cifi√©e'}</li>
                      <li><strong>Toppings:</strong> ${(item.details?.toppings || []).join(', ') || 'Aucune'}</li>
                  </ul>`;
          } else {
              li.innerHTML = `<strong>${item.name} (${item.quantity})</strong>`;
          }
          itemsList.appendChild(li);
        });
      } else {
        itemsList.innerHTML = '<li>Aucun article d√©taill√©.</li>';
      }
    }

    document.addEventListener('DOMContentLoaded', renderStatus);
    supabase.channel('order_tracking').on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
      const currentDemandId = localStorage.getItem('currentDemandId');
      if (payload.new.id === currentDemandId) {
        renderStatus();
      }
    }).subscribe();
  </script>
</body>
</html>