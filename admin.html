<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thaï Garden – Dashboard admin</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />

  <!-- Tailwind + couleurs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#704B24', accent: '#ED8B00' },
          fontFamily: {
            sans: ['Noto Sans', 'sans-serif'],
            serif: ['Playfair Display', 'serif']
          }
        }
      }
    };
  </script>
  <style>
    body { font-family: 'Noto Sans', sans-serif; }
    h1,h2 { font-family: 'Playfair Display', serif; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-800">

  <!-- Header -->
  <header class="fixed top-0 w-full bg-white/70 backdrop-blur-sm shadow z-50">
    <!-- Top bar -->
    <div class="max-w-5xl mx-auto flex items-center justify-between py-4 px-6">
      <span class="text-2xl font-bold text-primary">Dashboard Thaï Garden</span>
      <a href="index.html" class="text-accent font-semibold hover:underline">← Retour au site</a>
    </div>
    <!-- Secondary navigation -->
    <nav class="border-t border-gray-200">
        <div class="max-w-5xl mx-auto flex gap-4 px-6">
             <button id="tab-demandes" class="flex items-center gap-2 py-3 px-4 border-b-2 border-accent font-semibold">
                Demandes <span id="badge-demandes" class="ml-1 bg-red-500 text-white rounded-full px-2 text-sm hidden">0</span>
            </button>
            <button id="tab-commandes" class="flex items-center gap-2 py-3 px-4 text-gray-600 hover:text-primary">
                Commandes <span id="badge-commandes" class="ml-1 bg-red-500 text-white rounded-full px-2 text-sm hidden">0</span>
            </button>
             <button id="tab-historique" class="flex items-center gap-2 py-3 px-4 text-gray-600 hover:text-primary">
                Historique
            </button>
        </div>
    </nav>
  </header>

  <main class="pt-32 pb-12 max-w-5xl mx-auto px-4">

    <div id="view-demandes">
        <!-- Demandes en attente -->
        <h1 class="text-4xl font-extrabold text-primary text-center mb-10">Demandes en attente</h1>
        <div id="pending-container" class="space-y-4"></div>
    </div>

    <div id="view-commandes" class="hidden">
        <h1 class="text-4xl font-extrabold text-primary text-center mb-10">Commandes</h1>
        <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b">
                <th class="p-4">Client</th>
                <th class="p-4">Adresse</th>
                <th class="p-4">Créneau</th>
                <th class="p-4">Contenu</th>
                <th class="p-4">Total</th>
                <th class="p-4">Statut</th>
                <th class="p-4">Action</th>
              </tr>
            </thead>
            <tbody id="commandes-body">
              <!-- Les lignes de commande seront injectées ici par le JS -->
            </tbody>
        </table>
    </div>

    <div id="view-historique" class="hidden">
        <h1 class="text-4xl font-extrabold text-primary text-center mb-10">Historique des demandes</h1>
        <div id="history-container" class="space-y-4"></div>
    </div>

  </main>





  <template id="request-template">
    <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
      <div>
        <p class="text-lg font-semibold req-name"></p>
        <p class="text-gray-600 req-mode"></p>
        <p class="text-gray-600 req-phone"></p>
        <p class="text-gray-600 req-adresse"></p>
      </div>
      <div class="flex gap-2">
        <button class="px-4 py-2 bg-red-500 text-white rounded btn-refuse">Refuser</button>
        <button class="px-4 py-2 bg-green-500 text-white rounded btn-accept">Accepter</button>
      </div>
    </div>
  </template>

  <!-- Modal pour l’heure -->
  <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-xl font-semibold mb-4 text-center">Proposer une heure</h3>
      <input id="input-heure" type="time" class="w-full border rounded px-3 py-2 mb-4" required />
      <div class="flex justify-end gap-4">
        <button id="btn-cancel" class="px-4 py-2 border rounded">Annuler</button>
        <button id="btn-save" class="px-4 py-2 bg-accent text-white rounded">Valider</button>
      </div>
    </div>
  </div>

  <!-- Order Detail Drawer -->
  <div id="order-drawer" class="fixed inset-y-0 right-0 w-96 bg-white shadow-lg transform translate-x-full transition-transform z-[60]" role="dialog" aria-modal="true">
    <header class="flex justify-between items-center p-4 border-b">
      <h3 id="drawer-title" class="text-xl font-semibold"></h3>
      <button id="drawer-close" class="text-gray-600 hover:text-gray-800" aria-label="Fermer le panneau de détails">✖️</button>
    </header>
    <div id="drawer-content" class="p-4 overflow-y-auto h-[calc(100%-64px)]"></div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 hidden p-4 bg-gray-800 text-white rounded"></div>

</body>

  <script>
    /* === Simu base locale : tableau localStorage 'demandes' === */
    function loadDemandes() {
      return JSON.parse(localStorage.getItem('demandes') || '[]');
    }
    function saveDemandes(data) {
      localStorage.setItem('demandes', JSON.stringify(data));
    }

    function loadCommandes() {
        return JSON.parse(localStorage.getItem('commandes') || '[]');
    }

    function saveCommandes(data) {
        localStorage.setItem('commandes', JSON.stringify(data));
    }

    const commandesBody = document.getElementById('commandes-body');

    const pendingEl   = document.getElementById('pending-container');
    const historyEl   = document.getElementById('history-container');
    const tpl         = document.getElementById('request-template');
    const modal       = document.getElementById('modal');
    const inputHeure  = document.getElementById('input-heure');
    const btnCancel   = document.getElementById('btn-cancel');
    const btnSave     = document.getElementById('btn-save');
    let currentId     = null; // id de la demande en cours

    const tabDemandes = document.getElementById('tab-demandes');
    const tabCommandes = document.getElementById('tab-commandes');
    const tabHistorique = document.getElementById('tab-historique');
    const viewDemandes = document.getElementById('view-demandes');
    const viewCommandes = document.getElementById('view-commandes');
    const viewHistorique = document.getElementById('view-historique');

    const badgeDemandes = document.getElementById('badge-demandes');
    const badgeCommandes = document.getElementById('badge-commandes');

    const drawer = document.getElementById('order-drawer');
    const drawerTitle = document.getElementById('drawer-title');
    const drawerContent = document.getElementById('drawer-content');
    const drawerClose = document.getElementById('drawer-close');
    const toast = document.getElementById('toast');

    drawerClose.onclick = () => closeDrawer();

    function openDetailsDrawer(orderId) {
        const commandes = loadCommandes();
        const order = commandes.find(c => c.id === orderId);
        if (!order) return;

        // If the drawer is already open for this order, close it
        if (!drawer.classList.contains('translate-x-full') && drawerTitle.textContent.includes(order.id.slice(4))) {
            closeDrawer();
            return;
        }

        drawerTitle.textContent = `Commande #${order.id.slice(4)}`;
        let contentHtml = `
            <p><strong>Client:</strong> ${order.customer.name}</p>
            <p><strong>Adresse:</strong> ${order.customer.address}</p>
            <p><strong>Téléphone:</strong> ${order.customer.phone}</p>
            <p><strong>Créneau:</strong> ${order.deliverySlot}</p>
            <p><strong>Total:</strong> ${order.total.toFixed(2)}€</p>
            <h4 class="font-semibold mt-4">Articles:</h4>
            <ul>${order.items.length > 0 ? order.items.map(i => `<li>- ${i.name} (${i.quantity})</li>`).join('') : '<li>Aucun article détaillé.</li>'}</ul>
        `;
        drawerContent.innerHTML = contentHtml;
        drawer.classList.remove('translate-x-full');
    }

    function closeDrawer() {
      drawer.classList.add('translate-x-full');
    }

    // Close drawer when clicking outside
    document.addEventListener('click', (event) => {
      const isClickInsideDrawer = drawer.contains(event.target);
      const isDetailButton = event.target.classList.contains('text-accent'); // Assuming 'text-accent' is unique to detail buttons
      if (!isClickInsideDrawer && !isDetailButton && !drawer.classList.contains('translate-x-full')) {
        closeDrawer();
      }
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function setActiveTab(activeTab) {
        const tabs = [tabDemandes, tabCommandes, tabHistorique];
        const views = [viewDemandes, viewCommandes, viewHistorique];

        tabs.forEach((tab, index) => {
            const view = views[index];
            if (tab === activeTab) {
                view.classList.remove('hidden');
                tab.classList.add('border-accent', 'font-semibold');
                tab.classList.remove('text-gray-600', 'hover:text-primary');
            } else {
                view.classList.add('hidden');
                tab.classList.remove('border-accent', 'font-semibold');
                tab.classList.add('text-gray-600', 'hover:text-primary');
            }
        });
    }

    tabDemandes.addEventListener('click', () => setActiveTab(tabDemandes));
    tabCommandes.addEventListener('click', () => setActiveTab(tabCommandes));
    tabHistorique.addEventListener('click', () => setActiveTab(tabHistorique));

    /* Rendu initial */
    render();

    /* Re-render si localStorage change */
    window.addEventListener('storage', () => {
      render();
    });

    function render() {
      const demandes = loadDemandes();
      renderDemandes(demandes);

      const commandes = loadCommandes();
      renderCommandes(commandes);

      updateBadges(demandes, commandes);
    }

    function updateBadges(demandes, commandes) {
        const badgeDemandes = document.getElementById('badge-demandes');
        const badgeCommandes = document.getElementById('badge-commandes');

        const pendingDemandes = demandes.filter(d => d.statut === 'pending').length;
        badgeDemandes.textContent = pendingDemandes;
        badgeDemandes.classList.toggle('hidden', pendingDemandes === 0);

        const activeCommandes = commandes.filter(c => c.status !== 'Livrée').length;
        badgeCommandes.textContent = activeCommandes;
        badgeCommandes.classList.toggle('hidden', activeCommandes === 0);
    }

    function updateOrderStatus(orderId, newStatus) {
        const commandes = loadCommandes();
        const order = commandes.find(o => o.id === orderId);
        if (order) {
            order.status = newStatus;
            saveCommandes(commandes);
            render();
            showToast('Statut de la commande mis à jour.');
        }
    }

    function renderDemandes(data) {
      pendingEl.innerHTML = '';
      historyEl.innerHTML = '';

      data.forEach(req => {
        const node = tpl.content.cloneNode(true);
        node.querySelector('.req-name').textContent  = req.nom;
        node.querySelector('.req-mode').textContent  = req.mode;
        node.querySelector('.req-phone').textContent = req.tel;
        node.querySelector('.req-adresse').textContent = req.adresse;

        if (req.statut === 'pending') {
          node.querySelector('.btn-refuse').onclick  = () => updateStatut(req.id, 'refused');
          node.querySelector('.btn-accept').onclick  = () => openModal(req.id);
          pendingEl.appendChild(node);
        } else {
          // Transformation pour l’historique
          node.querySelector('.btn-refuse').remove();
          const btn = node.querySelector('.btn-accept');
          btn.className =
            'px-4 py-2 rounded text-white ' +
            (req.statut === 'accepted' ? 'bg-green-600' : 'bg-red-600');
          btn.textContent =
            req.statut === 'accepted' ? `Accepté à ${req.heure}` : 'Refusé';
          historyEl.appendChild(node);
        }
      });
    }

    function renderCommandes(commandes) {
        commandesBody.innerHTML = '';
        const statusConfig = {
            submitted: { icon: '⏳', color: 'bg-accent/10', text: 'En attente' },
            preparing: { icon: '<span class="text-accent-dark">🍳</span>', color: 'bg-yellow-100', text: 'En préparation' },
            ready: { icon: '<span class="text-green-600">✅</span>', color: 'bg-green-100', text: 'Prête' },
            delivered: { icon: '<span class="text-gray-500">🚚</span>', color: 'bg-gray-100', text: 'Livrée' }
        };

        commandes.forEach(order => {
            const config = statusConfig[order.status] || {};
            const tr = document.createElement('tr');
            tr.className = `border-b ${config.color || ''}`;
            tr.innerHTML = `
                <td class="p-4">${order.customer.name}</td>
                <td class="p-4">${order.customer.address}</td>
                <td class="p-4">${order.deliverySlot}</td>
                <td class="p-4">${order.items.length} article(s)</td>
                <td class="p-4">${order.total.toFixed(2)}€</td>
                <td class="p-4">
                    ${config.icon || ''} 
                    <select class="border rounded px-2 py-1" onchange="updateOrderStatus('${order.id}', this.value)">
                        <option value="submitted" ${order.status === 'submitted' ? 'selected' : ''}>${statusConfig.submitted.text}</option>
                        <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>${statusConfig.preparing.text}</option>
                        <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>${statusConfig.ready.text}</option>
                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>${statusConfig.delivered.text}</option>
                    </select>
                </td>
                <td class="p-4"><button class="text-accent underline" onclick="openDetailsDrawer('${order.id}')">Détail</button></td>
            `;
            commandesBody.appendChild(tr);
        });
    }

    function updateStatut(id, statut, heure='') {
      const data = loadDemandes();
      const item = data.find(r => r.id === id);
      if (item) {
        item.statut = statut;
        if (heure) {
            item.heure = heure;
        }
        saveDemandes(data);
        render();
        showToast('Statut de la demande mis à jour.');
      }
    }

    function openModal(id) {
      currentId = id;
      inputHeure.value = '';
      modal.classList.remove('hidden');
    }
    btnCancel.onclick = () => modal.classList.add('hidden');
    btnSave.onclick   = () => {
      if (!inputHeure.value) return;
      updateStatut(currentId, 'accepted', inputHeure.value);
      modal.classList.add('hidden');
    };
  </script>
</body>
</html>